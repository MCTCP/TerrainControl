// Build script for Terrain Control releases
// This script simply packs together the Bukkit and Forge jars

import java.util.zip.*;

// Project properties
archivesBaseName = "OpenTerrainGenerator"
description = "Open Terrain Generator: Generate anything!"

// Gets the JAR file for the project with the given name
def getJarFile(Project project)
{
    String fileName = project.archivesBaseName + '-' + project.version + '.jar'
    return new File(project.buildDir, 'distributions/' + fileName)
}

// Adds all files from the given zip file (source) to the given destination, which
// must also be a zip file. A set of already added files is maintained to prevent
// duplicates
def addToZip(File source, ZipOutputStream destination, Set<String> alreadyAddedFiles)
{
    byte[] buffer = new byte[4096]
    ZipInputStream inputStream = new ZipInputStream(new FileInputStream(source))
    ZipEntry nextEntry = inputStream.getNextEntry()
    while (nextEntry != null)
    {
        if (!alreadyAddedFiles.contains(nextEntry.name))
        {
            // Start new entry
            alreadyAddedFiles.add(nextEntry.name)
            destination.putNextEntry(new ZipEntry(nextEntry))

            // Transfer all bytes
            int bytesRead = inputStream.read(buffer)
            while (bytesRead > 0)
            {
                destination.write(buffer, 0, bytesRead)

                bytesRead = inputStream.read(buffer)
            }
        }

        // Done reading this entry, on to the next one
        nextEntry = inputStream.getNextEntry()
    }

    inputStream.close()
}

task createReleaseJar <<
{
	// We're including common only for the external libraries that are packaged with it (using Forge jar-in-jar).
	File commonFile = getJarFile(project(":common:common-core"))
    File forgeFile = getJarFile(project(":platforms:forge"))
    File spigotFile = getJarFile(project(":platforms:spigot"))
    File ourFile = getJarFile(project)

	if (forgeFile.exists() && spigotFile.exists())
    {
        ourFile.getParentFile().mkdirs()
        ZipOutputStream outputStream = new ZipOutputStream(new FileOutputStream(ourFile))
        Set<String> alreadyAddedFiles = new HashSet<String>()

        addToZip(forgeFile, outputStream, alreadyAddedFiles) // Add Forge first so its jar manifest is used
		addToZip(commonFile, outputStream, alreadyAddedFiles)
        addToZip(spigotFile, outputStream, alreadyAddedFiles)

        outputStream.close()
    } else {
        println(" Skipping the release jar, as the Spigot or Forge file failed")
		println(" Forge exists: " + forgeFile.exists())
		println(" Spigot exists: " + spigotFile.exists())
    }
}
